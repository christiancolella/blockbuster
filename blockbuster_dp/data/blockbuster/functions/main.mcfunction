# new block

## from armor stand
execute at @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] as @p if entity @s[x_rotation=-45..45,y_rotation=-45..45] as @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] at @s run summon armor_stand ~ ~0.226 ~-1 {Small:1b,Invisible:1b,NoGravity:1b,ShowArms:1b,NoBasePlate:1b,ArmorItems:[{},{},{},{id:"minecraft:diamond_block",Count:1b}],Pose:{RightArm:[0.0f,0.0f,-30.0f],LeftArm:[0.0f,0.0f,30.0f],RightLeg:[180.0f,0.0f,0.0f],LeftLeg:[180.0f,0.0f,0.0f]},DisabledSlots:4079166,Tags:["new_block"]}
execute at @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] as @p if entity @s[x_rotation=-45..45,y_rotation=45..135] as @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] at @s run summon armor_stand ~1 ~0.226 ~ {Small:1b,Invisible:1b,NoGravity:1b,ShowArms:1b,NoBasePlate:1b,ArmorItems:[{},{},{},{id:"minecraft:diamond_block",Count:1b}],Pose:{RightArm:[0.0f,0.0f,-30.0f],LeftArm:[0.0f,0.0f,30.0f],RightLeg:[180.0f,0.0f,0.0f],LeftLeg:[180.0f,0.0f,0.0f]},DisabledSlots:4079166,Tags:["new_block"]}
execute at @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] as @p if entity @s[x_rotation=-45..45,y_rotation=135..180] as @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] at @s run summon armor_stand ~ ~0.226 ~1 {Small:1b,Invisible:1b,NoGravity:1b,ShowArms:1b,NoBasePlate:1b,ArmorItems:[{},{},{},{id:"minecraft:diamond_block",Count:1b}],Pose:{RightArm:[0.0f,0.0f,-30.0f],LeftArm:[0.0f,0.0f,30.0f],RightLeg:[180.0f,0.0f,0.0f],LeftLeg:[180.0f,0.0f,0.0f]},DisabledSlots:4079166,Tags:["new_block"]}
execute at @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] as @p if entity @s[x_rotation=-45..45,y_rotation=-180..-135] as @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] at @s run summon armor_stand ~ ~0.226 ~1 {Small:1b,Invisible:1b,NoGravity:1b,ShowArms:1b,NoBasePlate:1b,ArmorItems:[{},{},{},{id:"minecraft:diamond_block",Count:1b}],Pose:{RightArm:[0.0f,0.0f,-30.0f],LeftArm:[0.0f,0.0f,30.0f],RightLeg:[180.0f,0.0f,0.0f],LeftLeg:[180.0f,0.0f,0.0f]},DisabledSlots:4079166,Tags:["new_block"]}
execute at @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] as @p if entity @s[x_rotation=-45..45,y_rotation=-135..-45] as @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] at @s run summon armor_stand ~-1 ~0.226 ~ {Small:1b,Invisible:1b,NoGravity:1b,ShowArms:1b,NoBasePlate:1b,ArmorItems:[{},{},{},{id:"minecraft:diamond_block",Count:1b}],Pose:{RightArm:[0.0f,0.0f,-30.0f],LeftArm:[0.0f,0.0f,30.0f],RightLeg:[180.0f,0.0f,0.0f],LeftLeg:[180.0f,0.0f,0.0f]},DisabledSlots:4079166,Tags:["new_block"]}
execute at @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] as @p if entity @s[x_rotation=-90..-45] as @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] at @s run summon armor_stand ~ ~-0.774 ~ {Small:1b,Invisible:1b,NoGravity:1b,ShowArms:1b,NoBasePlate:1b,ArmorItems:[{},{},{},{id:"minecraft:diamond_block",Count:1b}],Pose:{RightArm:[0.0f,0.0f,-30.0f],LeftArm:[0.0f,0.0f,30.0f],RightLeg:[180.0f,0.0f,0.0f],LeftLeg:[180.0f,0.0f,0.0f]},DisabledSlots:4079166,Tags:["new_block"]}
execute at @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] as @p if entity @s[x_rotation=45..90] as @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] at @s run summon armor_stand ~ ~1.226 ~ {Small:1b,Invisible:1b,NoGravity:1b,ShowArms:1b,NoBasePlate:1b,ArmorItems:[{},{},{},{id:"minecraft:diamond_block",Count:1b}],Pose:{RightArm:[0.0f,0.0f,-30.0f],LeftArm:[0.0f,0.0f,30.0f],RightLeg:[180.0f,0.0f,0.0f],LeftLeg:[180.0f,0.0f,0.0f]},DisabledSlots:4079166,Tags:["new_block"]}
execute as @e[type=armor_stand,tag=block,nbt={HandItems:[{id:"minecraft:bee_spawn_egg",Count:1b,tag:{CustomModelData:1}},{}]}] run data merge entity @s {HandItems:[{},{}]}

## from spawn egg
execute as @e[type=armor_stand,tag=new_block] run data merge entity @s {Rotation:[0.0f,0.0f]}
execute as @e[type=armor_stand,tag=new_block] at @s run tp ~ ~-0.226 ~
execute as @e[type=armor_stand,tag=new_block] run tag @s add block
execute as @e[type=armor_stand,tag=new_block] store result score @s self_pos_x run data get entity @s Pos[0] 1000
execute as @e[type=armor_stand,tag=new_block] store result score @s self_pos_y run data get entity @s Pos[1] 1000
execute as @e[type=armor_stand,tag=new_block] store result score @s self_pos_z run data get entity @s Pos[2] 1000
execute as @e[type=armor_stand,tag=new_block] run scoreboard players set @s self_vel_x 0
execute as @e[type=armor_stand,tag=new_block] run scoreboard players set @s self_vel_y 0
execute as @e[type=armor_stand,tag=new_block] run scoreboard players set @s self_vel_z 0
execute as @e[type=armor_stand,tag=new_block] store result score @s initial_pos_x run data get entity @s Pos[0] 1000
execute as @e[type=armor_stand,tag=new_block] store result score @s initial_pos_y run data get entity @s Pos[1] 1000
execute as @e[type=armor_stand,tag=new_block] store result score @s initial_pos_z run data get entity @s Pos[2] 1000
scoreboard players set @e[type=armor_stand,tag=new_block] anim_length 20
scoreboard players set @e[type=armor_stand,tag=new_block] time 0
execute as @e[type=armor_stand,tag=new_block] run tag @s remove new_block

# set up scores
execute as @e[type=armor_stand,tag=block] store result score @s self_uuid_0 run data get entity @s UUID[0]
execute as @e[type=armor_stand,tag=block] store result score @s self_uuid_1 run data get entity @s UUID[1]
execute as @e[type=armor_stand,tag=block] store result score @s self_uuid_2 run data get entity @s UUID[2]
execute as @e[type=armor_stand,tag=block] store result score @s self_uuid_3 run data get entity @s UUID[3]

execute as @e[type=armor_stand,tag=block] store result score @s self_pos_x run data get entity @s Pos[0] 1000
execute as @e[type=armor_stand,tag=block] store result score @s self_pos_y run data get entity @s Pos[1] 1000
execute as @e[type=armor_stand,tag=block] store result score @s self_pos_z run data get entity @s Pos[2] 1000

execute as @e[type=armor_stand,tag=block] store success score @s has_rot run data get entity @s Pose.Head
execute as @e[type=armor_stand,tag=block] if score @s has_rot matches 0 run data merge entity @s {Pose:{Head:[0.001f,0.001f,0.001f]}}

execute as @e[type=armor_stand,tag=block] store result score @s self_rot_x run data get entity @s Pose.Head[0] 1000
execute as @e[type=armor_stand,tag=block] store result score @s self_rot_y run data get entity @s Pose.Head[1] 1000
execute as @e[type=armor_stand,tag=block] store result score @s self_rot_z run data get entity @s Pose.Head[2] 1000

# collision box
scoreboard players set @e[type=armor_stand,tag=block] temp 0
function blockbuster:misc/collision_box

# edit mode
scoreboard players set @e[type=armor_stand,tag=block] temp 0
scoreboard players set @e[type=armor_stand,tag=block] global 0
function blockbuster:edit

# check relations and add tags
tag @e[type=armor_stand,tag=block] remove is_parent
tag @e[type=armor_stand,tag=block] remove has_parent
scoreboard players set @e[type=armor_stand,tag=block] temp 0
function blockbuster:parent/relation

scoreboard players set #depth global 0
scoreboard players set @e[type=armor_stand,tag=block,tag=!has_parent] temp 1
scoreboard players set @e[type=armor_stand,tag=block] depth -1
scoreboard players set @e[type=armor_stand,tag=block,tag=!has_parent] depth 0
function blockbuster:parent/depth

# animate
scoreboard players set @e[type=armor_stand,tag=block] temp 0
scoreboard players set @e[type=armor_stand,tag=block] global 0
function blockbuster:animate

# compute and apply parented transformations

## set identity matrix if no parent
scoreboard players set @e[type=armor_stand,tag=block,tag=!has_parent] parent_matrix_0 1000
scoreboard players set @e[type=armor_stand,tag=block,tag=!has_parent] parent_matrix_1 0
scoreboard players set @e[type=armor_stand,tag=block,tag=!has_parent] parent_matrix_2 0
scoreboard players set @e[type=armor_stand,tag=block,tag=!has_parent] parent_matrix_3 0
scoreboard players set @e[type=armor_stand,tag=block,tag=!has_parent] parent_matrix_4 1000
scoreboard players set @e[type=armor_stand,tag=block,tag=!has_parent] parent_matrix_5 0
scoreboard players set @e[type=armor_stand,tag=block,tag=!has_parent] parent_matrix_6 0
scoreboard players set @e[type=armor_stand,tag=block,tag=!has_parent] parent_matrix_7 0
scoreboard players set @e[type=armor_stand,tag=block,tag=!has_parent] parent_matrix_8 1000

scoreboard players set @e[type=armor_stand,tag=block] temp 0
scoreboard players set @e[type=armor_stand,tag=block] global 0
scoreboard players set #depth global 0
function blockbuster:transform

## merge transformations

execute as @e[type=armor_stand,tag=block,tag=has_parent] run scoreboard players operation @s temp = @s parent_vel_x
execute as @e[type=armor_stand,tag=block,tag=!has_parent] run scoreboard players operation @s temp = @s self_vel_x
execute as @e[type=armor_stand,tag=block] run scoreboard players operation @s temp *= #150 constants
execute as @e[type=armor_stand,tag=block] run scoreboard players operation @s temp /= #100 constants
execute as @e[type=armor_stand,tag=block] run scoreboard players operation @s self_pos_x += @s temp
execute as @e[type=armor_stand,tag=block] store result entity @s Pos[0] double 0.001 run scoreboard players get @s self_pos_x

execute as @e[type=armor_stand,tag=block,tag=has_parent] run scoreboard players operation @s temp = @s parent_vel_y
execute as @e[type=armor_stand,tag=block,tag=!has_parent] run scoreboard players operation @s temp = @s self_vel_y
execute as @e[type=armor_stand,tag=block] run scoreboard players operation @s temp *= #150 constants
execute as @e[type=armor_stand,tag=block] run scoreboard players operation @s temp /= #100 constants
execute as @e[type=armor_stand,tag=block] run scoreboard players operation @s self_pos_y += @s temp
execute as @e[type=armor_stand,tag=block] store result entity @s Pos[1] double 0.001 run scoreboard players get @s self_pos_y

execute as @e[type=armor_stand,tag=block,tag=has_parent] run scoreboard players operation @s temp = @s parent_vel_z
execute as @e[type=armor_stand,tag=block,tag=!has_parent] run scoreboard players operation @s temp = @s self_vel_z
execute as @e[type=armor_stand,tag=block] run scoreboard players operation @s temp *= #150 constants
execute as @e[type=armor_stand,tag=block] run scoreboard players operation @s temp /= #100 constants
execute as @e[type=armor_stand,tag=block] run scoreboard players operation @s self_pos_z += @s temp
execute as @e[type=armor_stand,tag=block] store result entity @s Pos[2] double 0.001 run scoreboard players get @s self_pos_z

execute as @e[type=armor_stand,tag=block] store result entity @s Pose.Head[0] float 0.001 run scoreboard players get @s self_rot_x
execute as @e[type=armor_stand,tag=block] store result entity @s Pose.Head[1] float 0.001 run scoreboard players get @s self_rot_y
execute as @e[type=armor_stand,tag=block] store result entity @s Pose.Head[2] float 0.001 run scoreboard players get @s self_rot_z

# collision box continued
execute as @e[type=armor_stand,tag=block,tag=has_collision] run scoreboard players operation @s last_self_pos_x = @s self_pos_x
execute as @e[type=armor_stand,tag=block,tag=has_collision] run scoreboard players operation @s last_self_pos_y = @s self_pos_y
execute as @e[type=armor_stand,tag=block,tag=has_collision] run scoreboard players operation @s last_self_pos_y += #726 constants
execute as @e[type=armor_stand,tag=block,tag=has_collision] run scoreboard players operation @s last_self_pos_z = @s self_pos_z
execute at @e[type=armor_stand,tag=block,tag=has_collision] positioned ~ ~0.726 ~ if block ~ ~ ~ air run setblock ~ ~ ~ barrier
